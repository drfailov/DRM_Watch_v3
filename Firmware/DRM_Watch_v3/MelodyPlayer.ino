
const byte groovyBlue[] = {
  125,
  0b10011101, 0b00100100, 0b00100100, 0b00100100, 0b00100100,
  0b10011000, 0b10011011, 0b10011000, 0b10011011, 0b10011101,
  0b00100100, 0b00100100, 0b00100100, 0b00100100, 0b10011000,
  0b10011011, 0b10011000, 0b10011011, 0b01011101, 0b10010001,
  0b01100100, 0b10010001, 0b01100100, 0b10010001, 0b01100100,
  0b10010001, 0b01100100, 0b10010001, 0b01100100, 0b10010001,
  0b01100100, 0b10011000, 0b10011011, 0b10011000, 0b10011011,
  0b01011101, 0b10011101, 0b01100100, 0b10011101, 0b01100100,
  0b10011101, 0b01100100, 0b10011101, 0b01100100, 0b10011101,
  0b01100100, 0b10011101, 0b01100100, 0b10011000, 0b10011011,
  0b10011000, 0b10011011, 0b01011101, 0b10011101, 0b01100000,
  0b10011101, 0b01100010, 0b10011101, 0b01100100, 0b10011101,
  0b01100000, 0b10011101, 0b10100010, 0b10100100, 0b10011101,
  0b01100100, 0b10011000, 0b10011011, 0b10011000, 0b10011011,
  0b01011101, 0b10011101, 0b01100000, 0b10011101, 0b01100010,
  0b10011101, 0b01100100, 0b10011101, 0b01100000, 0b10011101,
  0b10100010, 0b10100100, 0b10011101, 0b01100100, 0b10011000,
  0b10011011, 0b10011000, 0b10011011, 0b01011101, 0b10011101,
  0b01100000, 0b10011101, 0b01100011, 0b10011101, 0b01100010,
  0b10011101, 0b01100001, 0b10011101, 0b01100000, 0b10011101,
  0b01011111, 0b00100100, 0b10011000, 0b10011011, 0b10011000,
  0b10011011, 0b01011101, 0b11111111,
};
const byte blue[]  = {
    140,
    0b00001001, 0b00001010, 0b01000111, 0b01001010, 0b01001100, 
    0b01000101, 0b01001001, 0b00001010, 0b01000111, 0b01001010, 
    0b01001110, 0b00001111, 0b01001110, 0b01001100, 0b00001010, 
    0b01000111, 0b01001010, 0b01001100, 0b01000101, 0b01001001, 
    0b00001010, 0b01000111, 0b01001010, 0b01001110, 0b00001111, 
    0b01001110, 0b01001100, 0b00001010, 0b01000111, 0b01001010, 
    0b01001100, 0b01000101, 0b01001001, 0b00001010, 0b01000111, 
    0b01001010, 0b01001110, 0b00001111, 0b01001110, 0b01001100, 
    0b00001010, 0b01000111, 0b01001010, 0b01001001, 0b01000101, 
    0b01000101, 0b00000111, 0b11111111, 
};
const byte badinerie[]  = {
  125,
  0b01010111, 0b10011010, 0b10010111, 0b01010010, 0b10010111,
  0b10010010, 0b01001110, 0b10010010, 0b10001110, 0b00001011,
  0b10000110, 0b10001011, 0b10001110, 0b10001011, 0b10001101,
  0b10001011, 0b10001101, 0b10001011, 0b10001010, 0b10001101,
  0b10010000, 0b10001101, 0b01001110, 0b01001011, 0b01010111,
  0b10011010, 0b10010111, 0b01010010, 0b10010111, 0b10010010,
  0b01001110, 0b10010010, 0b10001110, 0b00001011, 0b01001110,
  0b01001110, 0b01001110, 0b01001110, 0b01010111, 0b01001110,
  0b11001110, 0b11001101, 0b11001110, 0b11001101, 0b01001101,
  0b01010010, 0b01010010, 0b01010010, 0b01010010, 0b01011010,
  0b01010010, 0b11010010, 0b11010001, 0b11010010, 0b11010001,
  0b01010001, 0b10001101, 0b10010010, 0b10010101, 0b10010010,
  0b10010100, 0b10010010, 0b10010100, 0b10010010, 0b10010001,
  0b10010100, 0b10010111, 0b10010100, 0b10010101, 0b10010100,
  0b10010101, 0b10010100, 0b10010010, 0b10010101, 0b10010010,
  0b10010001, 0b10010010, 0b10010111, 0b10010010, 0b10010001,
  0b10010010, 0b10011001, 0b10010010, 0b10010001, 0b10010010,
  0b10011010, 0b10010010, 0b10010001, 0b10010010, 0b10011010,
  0b10011001, 0b10010111, 0b10011001, 0b10010101, 0b10010100,
  0b10010010, 0b01010101, 0b01010100, 0b00010010, 0b11111111,
};
const byte mozart[]  = {
  240,
  0b01010101, 0b10010100, 0b10100100, 0b01010100, 0b01100100,
  0b01010101, 0b10010100, 0b10100100, 0b01010100, 0b01100100,
  0b01010101, 0b10010100, 0b10100100, 0b00010100, 0b00011100,
  0b00100100, 0b10100100, 0b01011100, 0b10011011, 0b10100100,
  0b01011001, 0b01100100, 0b01011001, 0b10010111, 0b10100100,
  0b01010101, 0b01100100, 0b01010101, 0b11100100, 0b10010100,
  0b10100100, 0b01010010, 0b01100100, 0b01010010, 0b00100100,
  0b01100100, 0b01010100, 0b11100100, 0b01010010, 0b11100100,
  0b01010010, 0b01100100, 0b01010100, 0b10010010, 0b10100100,
  0b01010010, 0b01100100, 0b01010100, 0b10010010, 0b10100100,
  0b00010010, 0b01011011, 0b00100100, 0b01100100, 0b01011011,
  0b01011001, 0b01011000, 0b01100100, 0b01011000, 0b01010101,
  0b01010100, 0b01100100, 0b11100100, 0b01010100, 0b01010010,
  0b01010000, 0b01100100, 0b01010000, 0b00100100, 0b01100100,
  0b01011100, 0b10011011, 0b10100100, 0b00011011, 0b00011110,
  0b00011000, 0b00011011, 0b00011001, 0b00010100, 0b00100100,
  0b01011100, 0b11100100, 0b10011011, 0b10100100, 0b00011011,
  0b00011110, 0b00011000, 0b00011011, 0b00011001, 0b00011100,
  0b01011011, 0b01011001, 0b01010111, 0b01010101, 0b00010100,
  0b00010011, 0b00010100, 0b00100100, 0b10001000, 0b10100100,
  0b10001000, 0b10100100, 0b00001000, 0b00100100, 0b10001000,
  0b10100100, 0b10001000, 0b10100100, 0b00001000, 0b00100100,
  0b10001000, 0b10100100, 0b10001000, 0b10100100, 0b01001000,
  0b01100100, 0b10001000, 0b10100100, 0b10001000, 0b10100100,
  0b01001000, 0b01100100, 0b10001000, 0b10100100, 0b10001000,
  0b10100100, 0b00001000, 0b11111111,
};
const byte mario[]  = {
  100,
  0b10010000, 0b10010000, 0b11100100, 0b01010000, 0b10001100,
  0b01010000, 0b01010011, 0b01100100, 0b01000111, 0b01100100,
  0b01001100, 0b10100100, 0b01000111, 0b10100100, 0b01000100,
  0b10100100, 0b01001001, 0b01001011, 0b10001010, 0b01001001,
  0b01000111, 0b10010000, 0b10010011, 0b01010101, 0b10010001,
  0b01010011, 0b01010000, 0b10001100, 0b10001110, 0b01001011,
  0b10100100, 0b01001100, 0b10100100, 0b01000111, 0b10100100,
  0b01000100, 0b10100100, 0b01001001, 0b01001011, 0b10001010,
  0b01001001, 0b01000111, 0b10010000, 0b10010011, 0b01010101,
  0b10010001, 0b01010011, 0b01010000, 0b10001100, 0b10001110,
  0b01001011, 0b01100100, 0b10010011, 0b10010010, 0b10010001,
  0b11111111,
};
const byte entertainer[]  = {
  140,
  0b01001110, 0b01001111, 0b01010000, 0b00011000, 0b01010000,
  0b00011000, 0b01010000, 0b00011000, 0b01011000, 0b01011010,
  0b01011011, 0b01011100, 0b01011000, 0b01011010, 0b00011100,
  0b01010111, 0b00011010, 0b00011000, 0b00100100, 0b01001110,
  0b01001111, 0b01010000, 0b00011000, 0b01010000, 0b00011000,
  0b01010000, 0b00011000, 0b01100100, 0b01010101, 0b01010011,
  0b01010010, 0b01010101, 0b01011000, 0b00011100, 0b01011010,
  0b01011000, 0b01010101, 0b00011010, 0b11111111,
};
const byte toreador[]  = {
  165,
  0b00011000, 0b00011010, 0b10011000, 0b00010101, 0b00010101,
  0b01010101, 0b10100100, 0b10010011, 0b00010101, 0b10010110,
  0b00010101, 0b00100100, 0b00010110, 0b00010011, 0b10011000,
  0b00010101, 0b00100100, 0b00010001, 0b00001110, 0b10010011,
  0b00001100, 0b00100100, 0b00010011, 0b01010011, 0b01011010,
  0b01011000, 0b01010110, 0b01010101, 0b11100100, 0b01010011,
  0b01010101, 0b01010110, 0b00010101, 0b00100100, 0b00010000,
  0b00010101, 0b00010101, 0b01010100, 0b01010111, 0b00011100,
  0b01100100, 0b11011010, 0b10011100, 0b11011010, 0b01011001,
  0b01011010, 0b01010011, 0b01010101, 0b00010110, 0b01100100,
  0b11010101, 0b10010110, 0b11010101, 0b01010001, 0b01011010,
  0b00011000, 0b00100100, 0b11010001, 0b10010011, 0b11010001,
  0b01001100, 0b01010110, 0b01010101, 0b01100100, 0b01010011,
  0b01100100, 0b01010001, 0b00100100, 0b00100100, 0b11111111,
};
const byte ukraine[] = {
    110,
    0b00010000, 0b01100100, 0b01010000, 0b01010000, 0b01001110, 
    0b01010000, 0b01010001, 0b00010011, 0b01100100, 0b01010001, 
    0b00010000, 0b00001110, 0b00001100, 0b00010000, 0b00001011, 
    0b00010000, 0b01001001, 0b01001000, 0b01001001, 0b01001011, 
    0b00001100, 0b00001110, 0b00010000, 0b01100100, 0b01010000, 
    0b01010000, 0b01001110, 0b01010000, 0b01010001, 0b00010011, 
    0b01100100, 0b01010001, 0b00010000, 0b00001110, 0b00001100, 
    0b00001001, 0b00010000, 0b00001000, 0b00001001, 0b00000100, 
    0b00001001, 0b11111111, 
};
const byte wasWollenWirTrinken[]  = {
  115,
    0b01001001, 0b01001001, 0b10000111, 0b10000110, 0b00000111, 
    0b00000100, 0b01000100, 0b01001001, 0b01001001, 0b01000111, 
    0b01000110, 0b01001001, 0b01001001, 0b10000111, 0b10000101, 
    0b00000111, 0b00000100, 0b01000110, 0b01000010, 0b00000100, 
    0b01100100, 0b01010101, 0b01010101, 0b10010011, 0b10010010, 
    0b00010011, 0b00010000, 0b01010000, 0b01010101, 0b01010101, 
    0b01010011, 0b01010010, 0b01010101, 0b01010101, 0b10010011, 
    0b10010001, 0b00010011, 0b00010000, 0b01010010, 0b01001110, 
    0b00010000, 0b01100100, 0b01010000, 0b01010011, 0b01010101, 
    0b00010111, 0b00010111, 0b01011000, 0b01010101, 0b00010111, 
    0b01100100, 0b01010101, 0b01010101, 0b10010011, 0b10010010, 
    0b00010011, 0b00010000, 0b01010000, 0b01010101, 0b01010101, 
    0b01010011, 0b01010010, 0b01010101, 0b01010101, 0b10010011, 
    0b10010001, 0b00010011, 0b00010000, 0b01010010, 0b01001110, 
    0b00010000, 0b11111111
};
const byte nokiaTune[] = {
  112,
  0b10011111, 0b10011101, 0b01010101, 0b01010111, 0b10011100,
  0b10011010, 0b01010001, 0b01010011, 0b10011010, 0b10011000,
  0b01010000, 0b01010011, 0b00011000, 0b11111111,
};


//----------------------//----------------------//----------------------//----------------------//----------------------//----------------------//----------------------



struct Melody {             
  String name;   
  const byte* data;         
  Melody(String _name, const byte* _data):name(_name), data(_data) {}
};    

Melody melodies[]={
  {"Badinerie", badinerie},
  {"Entertainer", entertainer},
  {"Nokia Tune", nokiaTune},
  {"Groovy Blue", groovyBlue},
  {"Ukraine", ukraine},
  {"Was Woller Wir Trinken", wasWollenWirTrinken},
  {"Blue", blue},
  {"Mozart", mozart},
  {"Mario", mario},
  {"Toreador", toreador}
};

int getMelodyCount(){
   return sizeof(melodies)/sizeof(melodies[0]);
}

String getMelodyName(int index){
   return melodies[index].name;
}

const byte* getMelodyData(int index){
   return melodies[index].data;
}





bool melodyPlayerLoopMelody = false;   
bool melodyPlayerCont = true;
String melodyPlayerMelodyName;
unsigned long melodyPlayerPlayStarted = 0;

void melodyPlayerSetMelodyName(String _name){
  melodyPlayerMelodyName=_name;
}
//return true if was played completely or false if interrupted
bool melodyPlayerPlayMelody(const byte* melody) {
  Serial.println(F("Set mode: PlayMelody"));
  melodyPlayerPlayStarted = millis();
  modeLoop = melodyPlayerDrawScreen;
  modeButtonUp = 0;
  modeButtonCenter = 0;
  modeButtonDown = 0;
  modeButtonUpLong = melodyPlayerButtonUp;
  modeButtonCenterLong = 0;
  modeButtonDownLong = melodyPlayerButtonDown;
  melodyPlayerCont = true;
  melodyPlayerLoopMelody = false;
  
  byte length = melodyPlayerGetLength(melody);
  int prequencyThreshold = 0;
  int lastFreq = 0;
  {//analyze melody
    long noteSum = 0;
    long noteCnt = 0;
    for (byte i = 1; i < length - 1 && melodyPlayerCont; i++) {
      byte b = (melody[i]);
      byte noteNumberByte = 0;
      for (byte i = 0; i < 6; i++)
        bitWrite(noteNumberByte, i, bitRead(b, i));
      float noteNumber = noteNumberByte;
      float frequency = 0;
      if (noteNumber < 36)
        frequency = 250.0 * pow(2.0, (noteNumber / 12.0));
      noteSum += frequency;
      noteCnt ++;
    }
    prequencyThreshold = 100 + noteSum/noteCnt;
    Serial.print("prequencyThreshold="); Serial.println(prequencyThreshold);
  }
  do{
    melodyPlayerDrawScreen();
    float tempo = (melody[0]);
    float whole_notes_per_second = tempo / 240.0;
    for (byte i = 1; i < length - 1 && melodyPlayerCont; i++) {
      byte b = (melody[i]);
      byte duration = 0;
      if (bitRead(b, 7) == 0 && bitRead(b, 6) == 0) duration = 4;
      if (bitRead(b, 7) == 0 && bitRead(b, 6) == 1) duration = 8;
      if (bitRead(b, 7) == 1 && bitRead(b, 6) == 0) duration = 16;
      if (bitRead(b, 7) == 1 && bitRead(b, 6) == 1) duration = 32;
      float timeMs = 1000.0 / (whole_notes_per_second * duration);
      byte noteNumberByte = 0;
      for (byte i = 0; i < 6; i++)
        bitWrite(noteNumberByte, i, bitRead(b, i));
      float noteNumber = noteNumberByte;
      // Note frequency is calculated as (F*2^(n/12)),
      // We can use C2=65.41, or C3=130.81. C2 is a bit shorter.
      float frequency = 0;
      //290 is ok
      if (noteNumber < 36)
        frequency = 250.0 * pow(2.0, (noteNumber / 12.0));
  
      long noteStarted = millis();
      if (frequency != 0){
        if(frequency>prequencyThreshold)
          ledFlashlightOnTop();
        else
          ledFlashlightOnBottom();
        lastFreq = frequency;
        buzTone(frequency);
      }
      else{
        ledFlashlightOffAll();
        buzNoTone();
      }
      while(millis() - noteStarted < timeMs-150){
        buttonsLoop();
        melodyPlayerDrawScreen();
      }
      while(millis() - noteStarted < timeMs);
      ledFlashlightOffAll();
      buzNoTone();
      delay(13);
      buttonsLoop();
    }
    ledFlashlightOffAll();
    buzNoTone();
    delay(500);
  }while(melodyPlayerLoopMelody);
  modeSetup();
  return melodyPlayerCont;
}

void melodyPlayerDrawScreen() {

  lcd()->setColorIndex(white);
  lcd()->drawBox(0, 0, 400, 240);

  lcd()->setFont(u8g2_font_10x20_t_cyrillic);  //ok
  lcd()->setCursor(5, 18); 
  lcd()->setColorIndex(black);
  lcd()->print("Плеєр");
  
  int x = drawStatusbar(363, 1, true);
  if(melodyPlayerLoopMelody)
    draw_ic16_repeat(x-16, 5, black);
  

  if(melodyPlayerCont){
    displayDrawVector(getPathZubat(), 130, 45, 3.0, 3, false, black);
    
    lcd()->setCursor(5, 230); 
    int sec = (millis()-melodyPlayerPlayStarted)/1000;
    if(sec < 10)
      lcd()->print("0");
    lcd()->print(sec);
    lcd()->print("s");

    int width = lcd()->getStrWidth(melodyPlayerMelodyName.c_str());
    lcd()->setCursor(200-width/2, 230); 
    lcd()->print(melodyPlayerMelodyName);
  }
  else{
    lcd()->setCursor(150, 120); 
    lcd()->print("Зупинка...");
  }



  lcd()->drawLine(369, 0, 369, 260);
  lcd()->drawLine(370, 0, 370, 260);
  draw_ic16_cancel(lx(), ly1(), black);
  draw_ic16_repeat(lx(), ly3(), black);
  lcd()->sendBuffer();
}


void melodyPlayerButtonUp(){
  melodyPlayerCont = false;
  melodyPlayerLoopMelody = false;
}
void melodyPlayerButtonDown(){
  melodyPlayerLoopMelody = !melodyPlayerLoopMelody;
}

void printBits(byte myByte) {
  for (byte mask = 0x80; mask; mask >>= 1) {
    if (mask & myByte)
      Serial.print('1');
    else
      Serial.print('0');
  }
}

int melodyPlayerGetLength(const byte* melody) {
  for (byte i = 0; i < 254; i++) {
    byte b = (melody[i]);
    if (b == 0b11111111) {
      return i + 1;
    }
  }
  return 0;
}














