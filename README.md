
<!-- For new line: \ -->
<!-- Picture: <img src="Photos/" width="300"/>  -->
<!-- New Line: "  <br>"  -->

# Про проект DRM Watch 3

<p align="center">
<img src="Photos/DRM3_welcome.png" width="700"/>
</p>

**DRM Watch 3** - це мій саморобний наручний годинник, в основі якого лежить дисплей Sharp Memory LCD, ESP32-S2 і бажання носити це на руці:)  <br>
Це **НЕ "Smart годинник"**! Цей пристрій по своїй функціональності близький до звичайного електронного годинника, з кількома додатковими можливостями, і їх можна додавати, перепрограмовувати годинник під себе.  <br>
Наразі в прошивці є всі можливості, що притаманні типовому годиннику і що дозволяє повноцінно використовувати його на щоденній основі.  <br>
В цьому репозиторії можна знайти інфу і інструкції **щоб зібрати собі такий годинник**.  <br>
  <br>
Це у мене таке хобі:) Я в кінці 2023 поліз вивчати проектування плат, після появи 3д принтера в 2022 поліз вивчати 3д моделювання, а за освітою програміст.  От власне це все і зібралось воєдино в цьому проекті) Робив це все з нуля. А яка б класна з цього була дипломна робота)))  <br>
  <br>
Посилання що наведено в цьому тексті є актуальними станом на **2024-04**. Якщо якісь товари будуть вже не актуальні, то шукайте за фотками))  <br>
  <br>


## Фото
<!--p align="center">
<img src="Photos/cad-angle.png" width="200"/>
<img src="Photos/cad-front.png" width="200"/>
<img src="Photos/cad-side.png" width="200"/>
</p-->

<p align="center">
<img src="Photos/DSC_3058.jpg" width="600"/>
</p>
<p align="center">
<img src="Photos/DSC_3069.jpg" width="200"/>
<img src="Photos/DSC_3055.jpg" width="200"/>
<img src="Photos/DSC_3094.jpg" width="200"/>
</p>
<p align="center">
<img src="Photos/DSC_3077.jpg" width="200"/>
<img src="Photos/DSC_3101.jpg" width="200"/>
<img src="Photos/DSC_3063.jpg" width="200"/>
</p>
<!--p align="center">
<img src="Photos/DSC_3084.jpg" width="200"/>
<img src="Photos/DSC_3097.jpg" width="200"/>
<img src="Photos/DSC_3115.jpg" width="200"/>
</p-->


## Відео про годинник
Тут є трохи:
https://www.tiktok.com/@drfailov



## Особливості годинника
- Зроблено в Україні;
- Стабільно працює і підходить для щоденного користування;
- Дисплей завжди показує час;
- В годиннику є вбудована "флешка" на 1.2МБ, в яку можна закинути файли
- Годинник може відкрити монохромний BMP, Wav файли, текстовий TXT документи
- Є дуже тускла але дуже приємна нічна підсвітка дисплея;
- Є ліхтарик, білий яскравий та червоний нічний;
- Акумулятора вистачає на понад 14днів, є індикатор заряду;
- Зручні меню, звідки можна отримати доступ до всіх функцій;
- Наявність Wi-Fi, можна зберегти до 8 мереж в пам'яті;
- Можливість синхронізації часу по Wi-Fi;
- Багато мелодій. Їх можна або просто слухати або встановити на будильник.
- Імітація звуку мявчання кошенят;
- Кілька циферблатів, які можна налаштувати;
- На циферблати можна додати календар, стрілочний годинник, дату, та цікавий фон
- Секундомір, працює в фоні;
- Будильники, до 6шт з назвами;
- Вічний календар (або я ще не догортав до кінця);
- Повнекранні клітинні автомати та анімації (Життя, Мураха, Вогонь, Шум, Лава, Мураха, Точки)
- Зарядка по USB, в тому числі від TypeC-TypeC;
- Можна оновлювати прошивку по USB, не розбираючи годинник.
- Компоненти для збірки легко дістати;
- Корпус підходить для стандартних 22мм ремінців;
- Зручно і просто прошивати. Можна написати свою прошивку.
- Якщо під час експериментів з прошивками годинник завис, в корпусі передбачено отвір щоб голкою його перезавантажити.
- Водонепроникність до 0 метрів:) (можна трохи покращити якщо при збірці обробити плату лаком а корпус збирати з клеєм.)
- Годинник можна використовувати як поле для експериментів з ESP32-S2: акумулятор, 3 кнопки, пищалка, дисплей, 3 світлодіоди;
- UART лог: інструмент для розробників, виводить на екран всі байти що надходять по UART.
- Екран "Про годинник" містить інформацію про розробника та версію прошивки.


## Застереження під час користування:
<p align="center">
<img src="Photos/no-water.png" width="100"/>
<img src="Photos/no-hammer.png" width="100"/>
<img src="Photos/no-esd.png" width="100"/>
</p>

- Годинник **не можна мочити**. Захист від води тут майже відсутній і це призведе до поломки годинника. Від дрібного дощу або поту йому нічого не буде, а от залити при митті рук - може бути проблемою.
- Годинник **слабко захищений від ударів**. Дисплей не захищений, тонкі рамки, тонкий корпус, годинник спроектований без великого запасу механічної міцності, так він  ще й досить габаритний. Тому вдарити його легко, і це скоріше за все призведе до розбитого дисплея. Протягом моїх місяців експлуатації проблем з пошкодженням годинника не було, але я користувався досить обережно.
- Годинник варто **оберігати від впливу статики**. Є невеликий шанс вбити годинник якщо швидко змімати з себе светр) Тому або знімайте светр повільно, або зніміть перед цим годинник, або використовуйте светр який не електризується. Особливо ризикований момент - постановка на зарядку, тут може проскочити прямо через контроллер. Раджу перед тим як вставити кабель зарядки, доторкнутись до металевої частини корпусу зарядного пристрою - так ви розрядитесь через корпус, а не через годинник і все буде ок.



## Короткий відео огляд годинника:
[<p align="center"><img width="300px" src="Photos/Screenshot 2024-04-21 161551.png" /> </p>](https://www.youtube.com/watch?v=3oIwZVaCEvY) 
<p align="center">https://www.youtube.com/watch?v=3oIwZVaCEvY </p>


## Короткий відео огляд мелодій:
[<p align="center"><img width="300px" src="Photos/Screenshot 2024-04-21 161739.png" /> </p>](https://www.youtube.com/watch?v=Ylm3CU0DTDE) 
<p align="center">https://www.youtube.com/watch?v=Ylm3CU0DTDE </p>





# Опис меню, функцій та екранів

## Основний екран, циферблат
<p align="center"> 
<img src="Photos/DRM_Watch3_Screenshot_20240917-220742.png" height=200"/>       
<img src="Photos/DRM_Watch3_Screenshot_20240917-220822.png" height=200"/>       
<img src="Photos/DRM_Watch3_Screenshot_20240917-221101.png" height=200"/>       
<img src="Photos/DRM_Watch3_Screenshot_20240917-221132.png" height=200"/>       
<img src="Photos/DRM_Watch3_Screenshot_20240917-221302.png" height=200"/>       
<img src="Photos/DRM_Watch3_Screenshot_20240917-221350.png" height=200"/>       
<img src="Photos/DRM_Watch3_Screenshot_20240917-221522.png" height=200"/>       
<!--img src="Photos/photo_2_2024-06-02_22-49-14.jpg" height=200"/> 
<img src="Photos/photo_51_2024-06-02_22-49-14.jpg" height=200"/> 
<img src="Photos/photo_52_2024-06-02_22-49-14.jpg" height=200"/> 
<img src="Photos/photo_50_2024-06-02_22-49-14.jpg" height=200"/> 
<img src="Photos/photo_46_2024-06-02_22-49-14.jpg" height=200"/> 
<img src="Photos/photo_44_2024-06-02_22-49-14.jpg" height=200"/> 
<img src="Photos/photo_22_2024-06-02_22-49-14.jpg" height=200"/> 
<img src="Photos/photo_17_2024-06-02_22-49-14.jpg" height=200"/-->
</p>

Тут відображаєтья час. Це основний екран годинника, на нього переходят більшість екранів по таймеру бездіяльності. На цьому екрані годинник заходить в сон і спить, просинаючись раз в хвилину щоб намалювати час.     <br>
Вміст циферблату можна налаштувати під себе, тому тут так багато різних його фоток        <br>
**Кнопка вгору** (коротке натиснення) - Відкрити секундомір.      <br>
**Кнопка вгору** (довге натиснення) - Відкрити таймер.      <br>
**Середня кнопка** (коротке натиснення) - Увімкнути ліхтарик.      <br>
**Середня кнопка** (довге натиснення) - вимкнути годинник.      <br>
**Кнопка вниз** - відкрити меню програм.      <br>

## Програми

<p align="center"> 
<img src="Photos/DRM_Watch3_Screenshot_20240825-210905.png" height=200"/> 
<!--img src="Photos/photo_3_2024-06-02_22-49-14.jpg" height=300"/--> 
</p>

Звідси можна запустити функції які не є налаштуваннями. Будильники, секундоміри, ігри, розваги, тощо.     <br>
З цього екрану годинник автоматично перейде на основний екран через кілька хвилин бездіяльності.    <br>
**Кнопками вгору та вниз** - обрати пункт меню.     <br>
**Центральна кнопка** - активує обраний пункт меню.      <br>

## Програми -> Будильник

<p align="center"> 
<img src="Photos/DRM_Watch3_Screenshot_20240917-221554.png" height=200"/> 
<img src="Photos/DRM_Watch3_Screenshot_20240917-221617.png" height=200"/> 
<img src="Photos/DRM_Watch3_Screenshot_20240909-214600.png" height=200"/> 
</p>

Будильник запускає відтворення заданої мелодії в заданий час дня.     <br>
З цього екрану годинник автоматично перейде на основний екран через кілька хвилин бездіяльності.    <br>
Можна налаштувати кілька будильників. До кожного можна задати час, назву та мелодію. Будильник спрацює якщо годинник заряджений і якщо годинник звісно знає поточний час. Спрацює також якщо в момент спрацювання ви знаходитесь в меню а не на циферблаті, а також спрацює якщо годинник вимкнено (але він при цьому заряджений).     <br>
**Кнопками вгору та вниз** - обрати пункт меню.      <br>
**Центральна кнопка** активує обраний пункт меню.      <br>
Коли пункт меню активований, **кнопки вниз та вгору міняють значення пункту**.     <br>
Під час будильника гратиме обрана мелодія і відображатиметься назва будильника та час на який будильник було встановлено. Під час спрацювання будильника його можна закрити (вимкнути на поточний раз), або вікласти на 10 або 5 хвилин (за умови якщо в цей момент не запущено таймер). Після спрацювання будильника він спрацює знову наступного дня. 

## Програми -> Календар

<p align="center"> 
<img src="Photos/DRM_Watch3_Screenshot_20240909-214037.png" height=200"/> 
<!--img src="Photos/photo_14_2024-06-02_22-49-14.jpg" height=300"/--> 
</p>

Показує календар на місяць.     <br>
З цього екрану годинник автоматично перейде на основний екран через кілька хвилин бездіяльності.    <br>
**Кнопками вгору та вниз** - змінити поточний місяць.     <br>
**Центральна кнопка** - вийти.     <br>

## Налаштування
<p align="center"> 
<img src="Photos/DRM_Watch3_Screenshot_20240825-210922.png" height=200"/> 
</p>

## Налаштування -> Дисплей
<p align="center"> 
<img src="Photos/DRM_Watch3_Screenshot_20240909-214158.png" height=200"/> 
</p>

### Інверсія
<p align="center"> 
<img src="Photos/DRM_Watch3_Screenshot_20240909-214352.png" height=200"/> 
<img src="Photos/DRM_Watch3_Screenshot_20240909-214315.png" height=200"/> 
</p>

### Мова
<p align="center"> 
<img src="Photos/DRM_Watch3_Screenshot_20240909-214352.png" height=200"/> 
<img src="Photos/DRM_Watch3_Screenshot_20240909-214331.png" height=200"/> 
</p>

### Калібрування акумулятора 
<p align="center"> 
<img src="Photos/DRM_Watch3_Screenshot_20240909-214218.png" height=200"/> 
</p>


Кожен годинник - унікальний, тому кожен показує заряд по своєму.      <br>
Щоб компенсувати цю неточність, я додав алгоритм який це виправляє, але для цього йому потрібно знати свою криву розряду. Щоб провести калібрування:      <br>
- повністю зарядити годинник 
- зняти з зарядки і пройти в налаштування -> дисплей ->калібрування акумулятора
- натиснути там початок калібровки.
- лишити годинник увімкненим на кілька годин поки він не вимкнеться.
Коли годинник вимкнеться, його можна поставити на зарядку і після цього він буде готовий до роботи з новою калібровкою     


## Програми -> Файли
<p align="center"> 
<img src="Photos/DRM_Watch3_Screenshot_20240909-215038.png" height=200"/> 
<img src="Photos/DRM_Watch3_Screenshot_20240909-215102.png" height=200"/> 
</p>



Важливо!!! Не зберігайте на годиннику цінну інформацію яка не має копії! У мене кілька разів "ламалась" файлова система і файли втрачались. 
Закономірностей цього явища поки не виявив, але я б не довіряв годиннику нічого цінного!

Формати файлів які може відкрити годинник:
- BMP монохромний. Такі файли можна сформувати з допомогою Microsoft Paint.
- DWM мелодії. Такі файли можна сформувати з допомогою програми в папці `Software\MIDI-to-Arduino-main`.
- WAV PCM 8bit аудіо. Такі файли можна сформувати з допомогою Audacity.
- TXT текстові файли в UTF8 кодуванні. Такі файли можна сформувати з допомогою Notepad++.
<p align="center"> 
<img src="Photos/bmp-create.png" height=300"/> 
<img src="Photos/audacity-wav.png" height=300"/> 
</p>


## Програми -> Менеджер пам'яті
<p align="center"> 
<img src="Photos/DRM_Watch3_Screenshot_20240917-221710.png" height=200"/> 
<img src="Photos/DRM_Watch3_Screenshot_20240917-221753.png" height=200"/> 
<img src="Photos/DRM_Watch3_Screenshot_20240917-221728.png" height=200"/> 
</p>

**Підключити до USB** - імітує підключену флешку.
**Показати карту розділів** - Відображає як поділена пам'ять ESP32.





## Програми -> Мелодії
<p align="center"> 
<img src="Photos/DRM_Watch3_Screenshot_20240917-222437.png" height=200"/> 
</p>

Меню зі списком мелодій. Можна переглянути назви та увімкнути мелодію. Їх там багато.     <br>
Я постійно додаю нові мелодії, зокрема з мемів. Додати свої мелодії також можливо, дивіться розділ як зібрати прошивку а потім як додати мелодію.     <br>
З цього екрану годинник автоматично перейде на основний екран через кілька хвилин бездіяльності.    <br>
**Кнопками вгору та вниз** - обрати мелодію.     <br>
**Центральна кнопка** - відкрити і відтворити мелодію.   <br>


## Програми -> Мелодії -> Плеєр
<p align="center"> 
<img src="Photos/photo_29_2024-06-02_22-49-14.jpg" height=300"/> 
</p>

Коли грає мелодія. Цей екран може бути запущений при спрацюванні будильника або якщо відкрити мелодію зі списку.    <br>
Якщо запущений при спрацюванні будильника:    <br>
**Кнопками вгору та вниз** - відкласти будильник. Мелодія зупиниться і буде запущено таймер на 10 або 5 хвилин. Якщо якийсь таймер вже запущений - відкласти будильник не вийде.     <br>
**Центральна кнопка** - Зупинити відтворення мелодії та повернутись до попереднього меню.      <br>  

Якщо запущений при відкриванні мелодії зі списку:    <br>
**Кнопка вниз** - увімкнути або вимкнути повтор мелодії. Якщо запущено повтор, в статусному рядку відображатиметься відповідна піктограма, а мелодія гратиме доки годинник не розрядиться.      <br>
**Центральна кнопка** - Зупинити відтворення мелодії та повернутись до попереднього меню.      <br> 


## Програми -> Таймер
<p align="center"> 
<img src="Photos/DRM_Watch3_Screenshot_20240917-221816.png" height=200"/> 
</p>

Таймер веде відлік заданого часу від моменту запуску. Коли час спливає, запускається звуковий сигнал.      <br>
З цього екрану годинник автоматично перейде на основний екран через кілька хвилин бездіяльності.    <br>  
**Кнопками вгору та вниз** - задається час на який встановлюється таймер.    <br> 
**Центральна кнопка** - або закриває програму, або запускає таймер.     <br> 
Коли лунає звуковий сигнал, його можна закрити, або вікласти на 10 або 5 хвилин.




## Програми -> Секундомір
<p align="center"> 
<img src="Photos/DRM_Watch3_Screenshot_20240917-221859.png" height=200"/> 
</p>

Веде відлік часу від моменту запуску.       <br> 
На цьому екрані годинник спить, і не виходить на циферблат.      <br> 
Секундомір може працювати в фоні. 
Поточне значення секундоміра (години, хвилини) відображатиметься в статусному рядку у всіх вікнах програми.       <br> 
Внизу відображається історія, які значення коли були скинуті.       <br> 
**Кнопка вгору** - Запустити або призупинити секундомір.     <br> 
**Кнопка вниз** - Скидає показник секундоміра.     <br> 
**Центральна кнопка** - вихід на циферблат.     <br> 


## Програми -> Ліхтарик
<p align="center"> 
<img src="Photos/photo_18_2024-06-02_22-49-14.jpg" height=300"/> 
</p>

Запускає ліхтарик. Програма при цьому ніяка не відкривається, просто вмикається світло.      <br> 
У ліхтарика два режими роботи - червоним світлодіодом і білим.       <br> 
Червоний буде корисним вночі - так він не сліпить і після його використання буде все ще добре видно вночі. 
Денний ліхтарик більш яскравий.      <br> 
Ліхтарик автоматично вимкнеться через кілька хвилин бездіяльності.  <br> 
**Один раз натиснути на кнопку** - якщо ліхтарик вимкнено - увімкнути нічний ліхтарик.      <br> 
**Другий раз натиснути** - увімкнути денний режим.      <br> 
**Якщо ліхтарик вже світить** - більше 5 секунд, то натиснення на кнопку його вимкне.      <br> 
Тобто якщо вночі запустити нічний ліхтарик, покористуватись ним, то натиснення на іконку ліхтарика не запустить денний ліхтар а вимкне ліхтар.      <br> 
Щоб запустити денний ліхтар - кнопку треба натиснути двічі протягом 2 секунд.      <br> 


## Програми -> Інженерне меню
<p align="center"> 
<img src="Photos/DRM_Watch3_Screenshot_20240909-214134.png" height=200"/> 
<img src="Photos/DRM_Watch3_Screenshot_20240909-213914.png" height=200"/> 
</p>

На цьому екрані зібрано максимум технічної інформації яка допоможе зрозуміти стан системи.      <br> 
На цьому екрані годинник спить, і не виходить на циферблат.      <br> 
**Центральна кнопка** - вийти до меню програм.      <br> 
**Кнопка вгору** - активувати чи вимкнути режим безсоння     <br>
В режимі безсоння годинник не буде йти в сон по таймеру. 
В цьому режимі годинник дуже швидко розрядиться, за кілька годин. 
В режимі безсоння в статусбарі буде відображатись інонка з кавою, а в інженерному меню буде написано "Don't sleep: 1".     <br>


## Програми -> Лог UART
<p align="center"> 
<img src="Photos/DRM_Watch3_Screenshot_20240909-220405.png" height=200"/> 
</p>

Годинник при підключенні до компа імітує на компі **COM порт**. 
Всі дані що надходять на COM порт - виводяться в лог на екрані.   <br>
Це може бути корисно якщо потрібно зрозуміти яку команду надсилає 
невідома вам програма до підключеного пристрою в процесі, наприклад, діагостики або реверс інжинірінгу.   <br>
Відображення відбувається в форматі лога, можна виводити як в текстовому форматі (ASCII) так і в форматі шістнадцяткових байтів (HEX).  <br>
На цьому екрані годинник не спить і не виходить на циферблат автоматично! Він буде увімкнений доти, доки його не вимкнути вручну або він не розрядиться повністю.  <br>
**Кнопка вгору** - ставить зображення на паузу - якщо потрібно детальніше вивчити отримані дані. Нові дані не будуть виводитись на екран.  <br>
**Центральна кнопка** - вийти до меню програм.  <br>
**Кнопка вниз** - перемкнути режим відображення (ASCII чи HEX).  <br>

## Програми -> Meow
<p align="center"> 
<img src="Photos/DRM_Watch3_Screenshot_20240909-215000.png" height=200"/> 
</p>

Симуляція мявчання кошенят. Генерується програмно випадковим чином. Можна обрати тон мявчання та вийти.


## Програми -> Життя
<p align="center"> 
<img src="Photos/DRM_Watch3_Screenshot_20240909-214932.png" height=200"/> 
</p>

Режим повноекранного кліткового автомату "Життя" (Convey's Game Of Life).    <br>
**Будь-яка з кнопок** - повернутись до меню програм.    <br>


## Програми -> Вогонь
<p align="center"> 
<img src="Photos/DRM_Watch3_Screenshot_20240909-214832.png" height=200"/> 
</p>

Режим повноекранної анімації вогню. Красиво. В основі лежить шум Перліна.    <br>
**Будь-яка з кнопок** - повернутись до меню програм.    <br>
Дякую за допомогу з реалізацією Кирилу Лейферу, ось його репозиторій: https://github.com/BOOtak/dct3ngine/blob/master/src/games/perlin_test



## Програми -> Лава
<p align="center"> 
<img src="Photos/DRM_Watch3_Screenshot_20240909-214857.png" height=200"/> 
</p>

Режим повноекранної анімації лави. Красиво. В основі лежить шум Перліна.    <br>
**Будь-яка з кнопок** - повернутись до меню програм.    <br>
Дякую за допомогу з реалізацією Кирилу Лейферу, ось його репозиторій: https://github.com/BOOtak/dct3ngine/blob/master/src/games/perlin_test



## Програми -> Мураха
<p align="center"> 
<img src="Photos/photo_43_2024-06-02_22-49-14.jpg" height=300"/> 
</p>

Режим повноекранного кліткового автомату "Мураха Ленгтона".    <br>
**Кнопки вниз або вгору** - змінити швидкість симуляції.    <br>
**Середня кнопка** - повернутись до меню заставок.    <br>


## Налаштування -> Вміст циферблату
Одночасно відображатиметься тільки один фон, тому щоб був відображався потрібний фон, потрібно залишити активний тільки один з доступних.    <br>
Кнопками вгору та вниз - обрати пункт меню. Центральна кнопка міняє обраний пункт меню. 





# Де брати комплектуючі
<p align="center"><img src="Photos/2024-09-29 Components-together.png"/> </p>
Готових годинників в продажу не існує, тому якщо є бажання отримати такий годинник, можна зібрати самому.

### Дисплей
<p align="center"><img src="Photos/5a768_electronic_circuits_gI_0_MemoryLCDPress.jpg" height="200"/> </p>

Дисплей потрібен, щоб відображати інформацію користувачу:)  <br>
Модель дисплея: **Sharp LS027B7DH01A**    <br>
Він звісно недешений, але мені дуже подобається як він виглядає. Його можна купити готовим, я купував тут:   <br>
https://www.aliexpress.us/item/1005005611440829.html  <br>


### Конектор дисплея
<p align="center"><img src="Photos/fpc.png" height="200"/> </p>

Для підключення цього дисплея. Я купував модулем, але можна пошукати і роз'єм окремо.  <br>
Модель: **FPC 10pin 0.5mm pitch** Я купував тут:    <br>
https://www.aliexpress.us/item/1005002288363000.html   <br>
https://www.aliexpress.us/item/10000348360254.html   <br>


### Акумулятор
<p align="center"><img src="Photos/battery.png" height="200"/> </p>

Якщо потрібно щоб пристрій працював автономно, то потрібен акумулятор.  <br>
Корпус та плата спроектовано під літій-іонний акумулятор такої форми: 35*25*5mm. Звісно, підійде будь-який і меншого розміру, але матиме меншу ємність.  <br>
Модель яка найкраще підходить: **lipo 502535**. Я купував тут:    <br>
https://prom.ua/ua/p1286391849-akkumulyator-kontrollerom-universalnyj.html   <br>

### Буззер
<p align="center"><img src="Photos/buzzer.png" height="200"/> </p>

Буззер потрібен щоб пищати, грати мелодії.  <br>
Модель: **Buzzer SMD 7525-3.6V-passive**. Я купував тут:    <br>
https://www.aliexpress.us/item/1005003620083880.html   <br>
https://eu.mouser.com/ProductDetail/CUI-Devices/CMT-7525S-SMT-TR?qs=qCxwlXJ4fnw4ZHFvNib47A%3D%3D


### Мосфет
<p align="center"><img src="Photos/mosfet.png" height="200"/> </p>

Мосфет використовується для того щоб керувати буззером, щоб на нього надходив не слабкий сигнал з мікроконтроллера, 
а потужний з батареї.    <br>
Модель: **2N7002LT1G**. Можна купити тут:    <br>
https://www.aliexpress.us/item/1005003079655220.html    <br>

### ESP32
<p align="center"><img src="Photos/1333_1.png" height="200"/> </p>

Я розпаював на комплектуючі плати **Lolin S2 Mini**, ось ссилка де я купував:  <br>
https://www.aliexpress.us/item/1005004438665554.html  <br>
  <br>
Якщо немає бажання розпаювати Lolin S2 Mini, можна купити комплектуху окремо:  <br>
<p align="center">
<img src="Photos/esp32s2.png" height=50"/> 
<img src="Photos/quartz.png" height=50"/> 
</p>

Датащіт:
https://www.espressif.com/sites/default/files/documentation/esp32-s2_datasheet_en.pdf 
Чіп: **ESP32-S2FN4R2, QFN56**  <br>
https://www.tme.eu/ua/details/esp32s2fn4r2/moduli-iot-wifi-bluetooth/espressif/esp32-s2fn4r2   <br>
Кварц: **SMD 3225 4pin 40MHz**:  <br>
https://www.aliexpress.us/item/1005004689346275.html  <br>


### Модуль зарядки акумулятора
<p align="center">
<img src="Photos/large_AOC777-1.jpg" height="200"/>  
</p>

Щоб була можливість заряджати акумулятор. Причому якщо акума не буде - годинник не працюватиме навіть на зарядці.   <br>
Тому якщо потрібно обійти модуль зарядки, можна замкнути перемичку біля мікросхеми заряду на платі (вона вона розташована біля самого краю плати) - вона подасть напряму напругу з USB порта замість напруги батареї. Основне не залишити перемичку зі вставленим акумом, щоб не отримати **фаєр-шоу**)))   <br>
Розпаявши такий модуль можна дістати чіп **TP4056** , який відоповідає за зарядку акума. Датащит:  <br>
https://dlnmh9ip6v2uc.cloudfront.net/datasheets/Prototyping/TP4056.pdf  <br>
Якщо нема бажання розпаювати модуль, можна знайти окремо:  <br>
<p align="center">
<img src="Photos/tp4056.png" height=50"/> 
<img src="Photos/usb.png" height=50"/> 
<img src="Photos/led.png" height=50"/> 
</p>

Чіп: **TP4056**  <br>
https://www.alibaba.com/product-detail/TC4056A-SOP-8-is-compatible-with_1600806443781.html  <br>
Роз'єм: **TYPE-C-31-M-12**  <br>
https://jlcpcb.com/partdetail/Korean_HropartsElec-TYPE_C_31_M12/C165948  <br>
Світлодіод: **0805 SMD LED**  <br>
https://www.aliexpress.us/item/4000936781234.html  <br>


### SMD Резистори
<p align="center"><img src="Photos/resistors.png" height="200"/>  </p>

Я робив плату під резистори **SMD 0603** (переважно), їх я брав з такого набору:   <br>
https://www.aliexpress.us/item/1005002364437129.html   <br>


### SMD Конденсатори
<p align="center"><img src="Photos/capacitorset.png" height="200"/>  </p>

Я робив плату під конденсатори **SMD 0603** (переважно), їх я брав з такого набору:   <br>
https://www.aliexpress.us/item/1005006124283234.html   <br>


### RTC модуль
<p align="center">
<img src="Photos/rtc.png" height="200"/>   
<img src="Photos/rtcchip.png" height="200"/>  
</p>

Використовується мікросхема **Analog Devices DS3231**, я її купував в складі такого модуля:   <br>
https://www.aliexpress.us/item/32822420722.html   <br>
Але можна також знайти мікросхеми окремо. Ось ще трохи інфи по ним:   <br>
https://octopart.com/ds3231-maxim+integrated-14739425
https://www.analog.com/en/products/ds3231.html   <br>
https://www.analog.com/media/en/technical-documentation/data-sheets/DS3231.pdf   <br>


### Світлодіод ліхтарика
<p align="center">
<img src="Photos/020led.png" height="200"/>  
<img src="Photos/lcd-backlight.png" height="200"/>  
</p>

Ці світлодіоди я діставав виключно з підсвітки старих телефонів, бо їх дисплеїв у мене багато.   <br>
Але я знайшов їх типорозмір щоб можна було замовити окремо: **020 SMD Side View LED White 6000K**.   <br>
Знайшов що тут можна замовити:  <br>
https://www.aliexpress.us/item/32419907074.html   <br>


### Кнопки
<p align="center"><img src="Photos/buttons.png" height="200"/>  </p>

Я так і не знайшов як їх можна назвати, тому шукаємо по фото і цьому тексту: **2\*4\*3.5mm Micro SMD Tact Switch Side Button**  <br>
https://www.aliexpress.us/item/32880903601.html    <br>


### Місця для гвинтів
<p align="center"><img src="Photos/smtso-brass.png" height="200"/>  </p>

Такі можна знайти на материнці DJI Mavic 3. Під гвинт М1.4  <br>
Орієнтовна назва: SMTSO Surface Mount Copper Nut M1.4X3X1.5-2X0.8  <br>
Щось схоже:  <br>
Обирати: M1.4X3X1.5-2X0.8 <br>
https://www.aliexpress.com/item/1005005579653583.html


### Гвинти для задньої кришки
<p align="center"><img src="Photos/screws-m14.png" height="200"/>  </p>

Я їх брав з материнки мавіка 3.  <br>
Тип: PH000, M1.4, 3mm  <br>  <br>
Приклад де замовити:  <br>
Обрати Size: M1.4 X 50pcs   Length: 3mm  <br>
https://www.aliexpress.com/item/1005002364568213.html  <br>

### Гвинти для передньої кришки
<p align="center"><img src="Photos/screw-case.png" height="200"/>  </p>

Я їх брав з Nokia 1280, вона скручена на такі.  <br>
Тип: T5, 1.5mm по пластику   <br>

Схожі можна замовити тут:  <br>
В складі набору є гвинти 1.4мм, вони мають підійти.  <br>
https://www.aliexpress.com/item/1005002324715062.html  <br>


### Електролюмінесцентна панель
<p align="center"><img src="Photos/el.png" height="200"/>  </p>

Цей елемент можна ставити або не ставити за бажанням, залежно від того чи потрібна вам нічна підсвітна екрана.   <br>
Електролюмінесцентна панель (EL панель) є складовою частиною системи підсвітки. Це панель, що світиться під впливом високої напруги і частоти. Також їх називають світлоконденсаторами (LEC). Це просто цікаві факти щоб краще розуміти що воно таке.  <br>
Фішка цього типу підсвітки в тому, що панель є дуже тонка, світить дуже рівномірно приємним синім кольором, а також її можна нарізати на фрагменти потрібної форми. Але після порізки складною є задача підключення до панелі. Я для підключення використовував одиночні жили дроти а також токопровідний клей.  <br>
Мінуси: будучи розташована за дисплеєм який тут використовується, її ледь-ледь видно, але вночі цього достатньо. Також трохи пищить при роботі. А ще для її роботи потрібна досить складна схема драйвера.  <br>
Раджу купувати синій колір, тому що EL панель натівно такого кольору, а в інші кольори її тупо фарбують, а фарба поглинає частину світла. Якщо прийшла пофарбована панель, її можна очистити від фарби лезом.  <br>
Ось де я купував:  <br>
https://www.aliexpress.us/item/1005003971896012.html  <br>


### Драйвер електролюмінесцентної панелі
<p align="center"><img src="Photos/h857.png" height="200"/>  </p>

Цей елемент можна ставити або не ставити за бажанням, залежно від того чи потрібна вам нічна підсвітна екрана.   <br>
Це та мікросхема, яка і формує змінну високу напругу для електролюмінесцентної панелі.   <br>
Схему її підключення я не розумію, просто зібрав по схемі і воно запрацювало))   <br>
Модель: **Microchip HV857MG MSOP8**   <br>
Датащит:   <br>
https://ww1.microchip.com/downloads/aemDocuments/documents/APID/ProductDocuments/DataSheets/HV857-High-Voltage-Low-Noise-EL-Lamp-Driver-IC-Data-Sheet-DS20005683.pdf   <br>
Я купував тут:  <br>
https://www.aliexpress.us/item/1005005512523052.html  <br>


### Обвязка драйвера електролюмінесцентної панелі
<p align="center">
<img src="Photos/capacitor.png" height=50"/> 
<img src="Photos/capacitorset.png" height=50"/> 
<img src="Photos/es1d.png" height=50"/> 
<img src="Photos/l.png" height=50"/> 
</p>

Цей елемент можна ставити або не ставити за бажанням, залежно від того чи потрібна вам нічна підсвітка екрана.   <br>
Насправді я в цій мелочовці взагалі не шарю, причому навіть деякі елементи замовив не ті що треба було... Але у мене воно запрацювало. Тому я кладу тут ссилки на те що я конкретно замовляв.   <br>

Модель: **Capacitor SMD 1206 10NF X7R 200V**   <br>
https://www.aliexpress.us/item/1005004628006766.html   <br>

Модель: **1206 320PCS 16Value**   <br>
https://www.aliexpress.us/item/1005006124283234.html   <br>

Модель: **Diode ES1D**   <br>
https://www.aliexpress.us/item/1005005254835443.html   <br>

Модель: **SMD Inductor 1210 3225 22UH**   <br>
https://www.aliexpress.us/item/32981310345.html   <br>


### Клей для електролюмінесцентної панелі
<p align="center"><img src="Photos/mechanic.png" height="200"/>  </p>


Цей елемент можна ставити або не ставити за бажанням, залежно від того чи потрібна вам нічна підсвітка екрана.   <br>
Цей клей я використовую для того щоб під'єднати дроти до електролюмінесцентної панелі. Детальніше про процес можна почитати в розділі "процес збірки".   <br>
Модель: **MECHANIC MCN-DJ002 Conductive Adhesive Glue Silver**   <br>
https://www.aliexpress.us/item/1005002369819447.html   <br>


### Ремінець
<p align="center">
<img src="Photos/band.png" height="200"/>  
<img src="Photos/pin.png" height="200"/>
<img src="Photos/pin-hole.png" height="200"/> 
</p>

Можна купити на алі, вибір великий. Потрібні стандартні ремінці **шириною 22мм**.   <br>
До прикладу, можна замовити тут:   <br>
https://www.aliexpress.us/item/1005005890436737.html   <br>

До ремінців як правило йдуть в комплекті і піни для встановлення, але якщо його в комплекті нема, можна замовити окремо:   <br>
https://www.aliexpress.us/item/1005006026719458.html   <br>


### Заглушка роз'єма USB
<p align="center"><img src="Photos/dust-plug.png" height="200"/>  </p>

Оскільки годинник використовується в умовах високої вологи та поту, нагальною є проблема 
окислення роз'єма USB, що з часом призводить до того що роз'єм працює нестабільно, а годинник 
стає все складніше заряджати або прошивати.   <br>
Використання подібних заглушок вирішує дану проблему.  <br>
Лишається тільки не загубити її:)  <br>
<br>
Я їх купував тут:  <br>
https://www.aliexpress.com/item/4000148621089.html


## Корпус
<p align="center">
<img src="Photos/case-front.png" height="250"/>  
<img src="Photos/case-back.png" height="250"/>
<img src="Photos/case-buttons.png" height="100"/>
</p>

Корпус спроектовано для простоти збірки та простоти друку на FDM 3D принтері. При цьому можна також замовити друк металом або фрезерування.  <br>
Малював корпус в Fusion 360, якщо потрібно щось змінювати, відкривайте файли `.f3d`. В папці купа версій, шукайте версію з новішою датою в назві.  <br>
Корпус спроектовано під **ремінці 22мм**.  <br>
Корпусні частини краще друкувати з чорного платику, а вкладку з кнопками - прозорим пластиком, щоб через нього світили ліхтарики.  <br>
В папці багато файлі і моделей, обираючи найновіший дивіться на номер версії або дату в назві файлу.  <br>
Для замовлення фрезерування та лазерного маркування вам знадобиться файл `.step` та `.dwg`.  <br>
Для друку металом або звичайним 3д принтером знадобиться `.stl` файл. (по одному на кожну частину корпусу)

## Плата
<p align="center">
<img src="Board/Photos/v4.png" height="330"/>  
</p>
<p align="center">
<img src="Photos/board1.png" height="100"/>  
<img src="Photos/board3.png" height="100"/>  
<img src="Photos/board2.png" height="100"/>  
<img src="Photos/board4.png" height="100"/>  
<img src="Photos/board5.png" height="100"/>  
</p>

Корпус спроектований під плату товщиною **0.8mm**. Колір плати можна обирати на свій смак, я обирав чорні.  <br>
В папці можна знайти плати різних ревізій, коротко про ревізії:  <br>
**Rev 1:** конденсатори розміщені надто далеко від контроллера, конденсаторів мало, 
немає елементів що формують EN для контроллера, нема RTC мікросхеми, антена на платі неефективна, 
розпіновка в деяких моментах відрізняється від нової ревізії, елементи розміщені не плотно, немає ніякої підсвітки.  <br>
**Rev 2:** вісутні підтяжки RTC SCL та SDA. Елементи розміщені не плотно, підсвітна світлодіодна і неефективна.  <br>
**Rev 3:** Помилок по схемі наче поки немає, я зібрав і воно одразу запрацювало. 
Підсвітка електролюмінесцентна з драйвером. Компоненти розміщені плотно. Можна поставити великий акум на 500мАг.  <br>
**Rev 4:** Додано піни щоб підключити до RTC окремий акум щоб не збивався час при розрядці акумулятора, 
додано елементи які відповідають за роботу вібро. Поки програмно він ніяк не задіяний, але хай буде.  <br>  

Щоб замовити собі плату, можна скористатись файлами в папках GERBER. Знаходяться вони тут: `Board\Gerber OUTPUTs`  <br>
Ці файли достатньо завантажити на сайт не виготовляють плати, я замовляв у **jlcpcb.com**. 
Там одразу має бути видно як виглядатиме плата.   <br>
Якщо потрібно щось поміняти - ставимо KiKad, відкриваєм проект `Board\KiCad Project\_DRM_Watch_v3\DRM_Watch_V3.kicad_pro` і можна міняти.   <br>
Експортувати Gerber на Drl можна в редакторі плат KiKad.  <br>
Також в схемі в проекті я до кожного елемента пододавав інфу про те де його можна замовити (якщо знаю звісно)  <br>


### Пайка елементів на плату
<p align="center">
<img src="Photos\2024-09-29 Board Soldering Plan.png" height="330"/>  
</p>

В проекті KiKad є більше інфи що і куди паяти, що з чим з'єднано. Якщо немає бажання відкривати проект, то я вивів потрібну інфу в файл `Doc\2024-09-29 Board Soldering Plan.pdf`

### Замовлення зібраної плати
Деякі виробники плат в Китаї пропонують замовлення плат вже готовими і зібраними (PCBA = PCB Assemply). Як правило процес замовлення не надто автоматизований, а робота таких виробників покладається на роботу менеджерів. Тому такі замовлення вони часто приймають у форматі особистої переписки в месенджерах.  <br>
Для такого замовлення їм треба наступна інформація:
- Gerberи плати. Це формується з редактора плат KiKad в файли `.gbr` і містить інформацію про саму плату (всі її шари). Один файл `.gbr` це один шар плати. Можна взяти в папці `Board/2024-04-18 GERBER REV4` (або новішу).
- Список елемнетів які розміщено на платі, тобто файл BOM. Він формується зі схеми в KiKad в файл `.csv` і містить інформацію про номер елемента на платі, виробника, назву компонента, посилання де його можна замовити, та опис кожного елемента. Можна взяти в папці `Board/2024-04-18 GERBER REV4` (або новішу).
- Інформацію про розміщення елементів на поверхні плати. В моєму випадку це окремий шар на Gerber плати, а саме `DRM_Watch_V3-F_Fab.gbr`. Там я розписав розміщення елементів, причому я робив це для себе в довільному по суті форматі, але цей файл підійшов для замовлення.
- Інформація про тип плати, в моєму випадку це товщина **0.8mm** та колір чорний.



# Процес збірки та налагодження

## Підготовка електролюмінесцентної панелі
<p align="center">
<img src="Photos/el1.png" height=180"/> 
<img src="Photos/el2.png" height=180"/> 
<img src="Photos/el3.png" height=180"/> 
<img src="Photos/el4.png" height=180"/> 
</p>

Оскільки щоб встановити електролюмінесцентну панель, її потрібно **порізати**, то з'являється проблема її підключення, 
адже контакти панелі відріжуться. Окрім того все підключення слід виконати **дуже компактно**, оскільки місця під дисплеєм мало.   <br>
У тих панелей що я замовляв, на зворотній стороні можна було бачити, що два контакти які живлять панель **проходять по вьому її периметру**. В них і будем підключатись. Щоб все працювало треба один дріт підключити до зовнішнього електрода, а другий до центрального.   <br>
Підключатись будемо одною **тонкою жилою багатожильного дроту**. Вона звісно дуже тендітна, але в зібраному годиннику це не проблема.   <br>
Я робив так: 
- беремо гостре (свіже, незатуплене) лезо, і під мікроскопом **розрізаємо ламінацію панелі**. Діяти треба обережно, щоб не пошкодити 
нічого зайвого.   <br>
- Далі в цей розріз обережно **запихуємо кінець жили дроту**, пінцетом або лезом. Бажано щоб всередину помістилось хоча б 4мм дроту.   <br>
- Далі набираємо на зубочистку провідний клей, зовсім трішки, і **набиваємо провідний клей всередину** вслід за дротом. Далі чекаємо поки клей засохне.   <br>
- Процес засихання клею можна прискорити прогрівши місце поклейки до температути приблизно **100 градусів на хвилин 20**. Я робив це на паяльному столику.   <br>
- Після поклейки вигинаємо жили дроту так щоб вони виходили до контактів `EL1` та `EL2` на платі, і всю цю поклейку і **жили фіксуємо скотчем.**    <br>
<br>

На цьому етапі ми маємо панель з двома надтонкими жилами які виходять з неї. Можна паятись до плати і має працювати.   <br>
Якщо не працює - варіанти звісно два, або платою не генерується напруга або щось не так з панеллю.    <br>
Плату перевірити легко - звичайним мульмиметром в режимі **вимірювання змінної напруги** поміряти між `EL1` та `EL2`. Має бути приблизно 90 вольт змінного струму.   <br> Якщо напруга є - проблема в панелі.

## Інструменти та розхідники
<p align="center"><img src="Photos/preheater.png" height=180"/> </p>

Мені дуже допомогла в пайці така прикольна паяльна станція:  <br>
https://www.aliexpress.us/item/1005005609080807.html  <br>


<p align="center"><img src="Photos/breakout.png" height=180"/> </p>

На етапі налагодження може допомогти такий **QFN56 Breakout Board** який підійде для ESP32-S2 (нагадую, там корпус QFN56)  <br>
https://www.aliexpress.us/item/1005002805132028.html  <br>

<p align="center"><img src="Photos/urethan.png" height=180"/> </p>

**Uretan 71**  <br>
Для покриття плат лаком я використовував таку штуку як **Uretan 71**. Наносив за допомогою маленького пензля в два шари.   <br>


## Інструменти, які я використовував при проектуванні:
- Проектування плати та схеми: **KiCad 7.0.9**;
- Формування BOM: **bom_csv_grouped_by_value_with_fp.py** (розташований в папці `Board`);
- Написання прошивки: **VSCode** (проект в папці `Firmware`);
- Розширення плати: **PlatformIO + Espressif32** (В списку плат оберіть "Lolin S2 Mini");
- Конвертування іконок: **Програма LCD Assistant**. (Виберіть Horizontal).
- Написання флешера: **Visual Studio + C# + WindowsForms + .NET Framework 4.6**.



# Прошивка
Прошивка написана на C++ в **VSCode 1.89.1** з використанням розширення **PlatformIO**, компілювати треба під плату **Lolin S2 Mini**.   <br>
Як не складно помітити, прошивка містить багато робочих екранів (я їх назвав режимами або Mode). Кожен з них - це окремий набір функцій Setup, Loop, Exit, OnButton..., тощо.   <br>
Перехід між режимами (екранами) здійснюється викликом функції `SetupMode...()` для відповідного режиму (екрану) який треба запустити. Ця функція має замінити адреси виконавчих функцій на свої.   <br>
Кожен режим в прошивці (поточний екран, mode) - це комплект функцій які займаються відмальовуванням екрану та обробкою кнопок. Кожен режим може робити по суті що завгодно.   <br>
Основний спосіб навігації в прошивці це змінні типу `Runnable`:  `modeSetup, modeLoop, modeButtonUp, modeButtonCenter, modeButtonDown, modeButtonUpLong, modeButtonCenterLong, modeButtonDownLong`.    <br>
Ці змінні знаходяться в файлі Global і доступні з усієї програми. В кожен момент часу містять посилання на функції які відповідають поточному режиму (екрану). Саме ці змінні викликає кореневий Loop.   <br>
Коли потрібно перемкнути режим (поточний екран), функція `modeSetup` відновідного режиму має перезаписати ці посилання, 
і відновідно `loop` викликатиметься вже інший, малюватиметься інша інфа, користувач бачитиме інший екран та взаємодіятиме з ним.   <br>
   <br>
 
- **enableAutoReturn** - чи з цього режиму годинник виходитиме автоматично якщо його залишити. Ця логіка реалізована в коненевому Loop.	
- **enableAutoSleep** - Чи в цьому режимі годинник буде спати не виходячи з нього. Важливо пам'ятати що сон стирає всю оперативку. Ця логіка реалізована в коненевому Loop.


**modeSetup** - поточного режиму функція входу. Вона має:
- Виконати modeExit якщо вона не нульова (щоб завершити попередній режим)
- Відтворити анімацію виходу з попереднього меню: clearScreenAnimation()
- Задати змінні для даного режиму: modeSetup, modeLoop, modeExit. Якщо щось з цього нема, ТРЕБА задати 0.
- Задати дії кнопок доя даного режиму: modeButtonUp, modeButtonCenter, modeButtonDown, modeButtonUpLong, modeButtonCenterLong, modeButtonDownLong.  Якщо щось з цього нема, ТРЕБА задати 0.
- Викликати registerAction();
- Задати правила цього режиму: enableAutoReturn, enableAutoSleep, autoReturnTime, autoSleepTime.
  <br>
**modeLoop** - поточного режима Loop функція. 
- Намалювати екран
- Обробити дані
- кнопки обробляти тут не треба оскільки вони обробляються окремо і будуть викликані відповідні функції.
  <br>
**ModeExit** - функція призначена для завершення "роботи" що робилась в поточному режимі.
- Можна почистити пам'ять
- Позакривати файли якщо відкриті
- вимкнути вайфай, діоди, чи що ще використовувалось
- при виконанні завжди в ній треба додавати modeExit = 0; щоб не було повторного запуску 


## Структура роботи батареї
В процесі виявлення рівня заряду застосовується
- Усереднене значення кількох замірів
- Виявлення аномалій в значеннях та відсікання аномальних
- Таблиця калібровки для розрахунку відсотка
- Гістерезис для ігнорування дрібних змін відсотка
- Дабл-чек якщо є підозра на 

Послідовність руху даних:
- `analogRead()`   <br>
Беремо сире зашумлене значення з ADC.   <br>
**Діапазон:** [0...8096], **Шумів** - ДУЖЕ багато.

- `analogSmoothRead()`    <br>
Згладжуємо середнім - протитавши кілька разів поспіль.   <br>
**Діапазон:** [0...8096], **Шумів** - багато.

- `readSensBatteryRaw()`   <br>
Функція для спрощення виклику по програмі.   <br>
**Діапазон:** [0...8096], **Шумів** - багато.
  
- `readSensBatteryRawFiltered()`   <br>
Рахуємо середнє, девіацію кожного значення відносно середнього, середнє девіації та ліміт девіації.   <br>
Всі значення девіація яких виходить за межі ліміту, відсікаємо (заміняємо середнім).   <br>
А далі фільтроване значення усереднюєм.   <br>
**Діапазон:** [0...8096], **Шумів** - нормальна кількість.

- `batteryCalibrationGetValuePercent(raw)`   <br>
На основі отриманого Raw рахуємо відсоток заряду на основі таблиці калібровки яка   <br>
була сформована під час повної калібровки вручну.   <br>
**Діапазон:** [0...100], **Шумів** - нормальна кількість.
   
- `getBatteryBars()`   <br>
Беремо відсоток і застосовуємо до нього гістерезис, ігноруючи дрібні зміни відсотка.   <br>
На основі відсотка рахуємо кількість "палочок"   <br>
**Діапазон:** [0...4], **Шумів** - небагато.

- `isBatteryCritical()`
Беремо кількість палочок і дивимось чи годинник в глибокому розряді.   <br>
Якщо в глибокому - перевіряємо ще раз.   <br>
**Діапазон:** [0...1], **Шумів** - не повинно бути.
   

### Як прошити годинник
<p align="center">
<img src="Photos/flasher-wait.png" height=200"/> 
<img src="Photos/flasher-connected.png" height=200"/> 
<img src="Photos/flasher-complete.png" height=200"/> 
</p>
Найпростіший спосіб - скористатись програмою флешером.  <br>
В релізі можна знайти готову програму яка вже включає в себе файли з потрібною прошивкою.  <br>
Потрібно тільки підключити годинник в режимі прошивки і далі слідувати інструкції.     <br>
   
### Як скомпілювати прошивку
- Скачати **VSCode** (У мене 1.89.1)
https://code.visualstudio.com/docs/?dv=win64user
- Встановити розширення **PlatformIO** (у мене Core 6.1.15·Home 3.4.4)   
Extensions -> в пошук "PlatformIO IDE" -> Install
- Встановити платформу **Espressif 32** (у мене Core 6.6.0)
PlatformIO Home (Відкривається при запуску) -> бокове меню Platforms -> Emnedded -> в пошук "Espressif 32" -> Install
- Відкрити проект **Firmware\DRM Watch 3**
PlatformIO Home (Відкривається при запуску) -> Open Project -> знайти і обрати папку "Firmware\DRM Watch 3"
- Далі коли проект відкрився, внизу натиснути **"Upload"**
Після цього PlatformIO скачає купу всього ще, щоб зібрати прошивку і скомпілить прошивку. Перший раз компілитиме довго, наступні рази буде швидше. 
І Після цього він спробує залити прошивку на підключений по USB годинник.




### Як додати іконку і використати її в меню
<p align="center"><img src="Photos/icons.png" height="200"/>  </p>

**Загалом послідовність така:**
- Мати іконку 24х24 пікселі, зберегти її в форматі **монохромному BMP форматі**;
- Відкрити програму **LCDAssistant.exe**.
- **Load Image** - Обираємо монохромний BMP файл. Файл відкривається, бачимо що показується правильно.
- **Byte orientation** обираємо **Horizontal**.
- **Save Output** - обираємо текстовий файл куди збережемо код.
- Код вставляємо в файл **Icons.ino** (можна звісно інший, але в цьому проекті так прийнято).
- Формуємо для іконки `draw_` функцію за прикладом інших іконок.
- Вставляємо нашу `draw_` функцію в відображення меню.
- Готово. Компілюємо і має працювати.


**Відео як це зробити:**   <br>
(відео таке трішки простеньке, але суть передає)   <br>
https://www.youtube.com/watch?v=P4BCf7cneI8   <br>



### Як додати до прошивки свою мелодію:
<p align="center"><img src="Photos/melody.png" height="200"/>  </p>


1) Знайти мелодію. Це має бути midi файл у якого один із інструментів має містити мелодію повністю. 
Я для пошуку мелодій використовую сайт https://onlinesequencer.net/sequences . Там же можна підправити мелодію щоб вона краще підійшла для годинника.
2) Конвертувати мелодію в формат мелодій годинника. Для цього я дещо модифікував інструмент від ShivamJoker, який тепер генерує мій формат мелодій. Конвертер знаходиться в папці `Software\MIDI-to-Arduino-main`. Для його роботи встановіть NodeJS собі на комп.	
3) В файлі `MelodyPlayer.ini` додаємо масив даних мелодії в файл а також додаємо мелодію та її ім'я до масиву `melodies`. 
4) Цього має бути достатньо. Компілюємо прошивку і має з'явитись нова мелодія.

Зауважу, що після додавання нової мелодії, вона посуне індекси попередніх мелодій і якщо мелодія була обрана для будильника, вона зміститься.    <br>

Я записав відео процесу додавання мелодії:   <br>
https://www.youtube.com/watch?v=u_XPCM6kgQM

Формат масиву:   <br>
- Додатнє число - частота в Гц який потрібно вітворити
- Від'ємне число - час, скільки треба тримати частоту. Від'ємне число після частоти - тривалість частоти. Якщо від'ємних кілька підряд то це паузи.
- 19 - ідентифікатор кінця мелодії. Його треба ставити обов'язково бо система почне відтворювати сміття із оперативки.


### Відомі конфлікти між бібліотеками або пінами
- Temperature measurement is hanging system if after Wi-Fi usage it were not initialized.
- Pin D17 - Stays ON when firmware update
- Pin D31 - Used for flash communication
- Pin D32 - Used for flash communication


## Цікаві факти:
- Щоб загнати в режим прошивки ESP32-S2 достатньо підключитись до неї по COM порту з баудом 1200.
- Процес маркування металевого корпусу: https://youtube.com/shorts/PZIMB8fdEP8?si=xofTaj4oOFBRnQQU


## Посилання на ресурси

- Дякую за код для "Вогню": https://github.com/BOOtak/dct3ngine/blob/master/src/games/perlin_test

- Big repository of phone melodies where I found some melodies
http://onj3.andrelouis.com/phonetones/unzipped/

- Vibration implementation
https://makeabilitylab.github.io/physcomp/advancedio/vibromotor.html



## Історія проекту
- 2023 рік: я десь наткнувся на відео про sharp memory lcd зрозумів, що дуже хочу собі такий дисплей. Замовив на алі.
- 2023 кінець року: Таки дійшои руки до замовленого дисплея, було бажання розібратись з проектуванням плат, тож я спробував створити свій перший проект в KiCad.
- 2024 рік, в новорічну ніч я програмував перший прототип, який ще навіть не мав своєї плати, був зібраний на картонці.
- 2024 рік, вечорами після роботи по невеличкій частинці на день я покращував прошивку
